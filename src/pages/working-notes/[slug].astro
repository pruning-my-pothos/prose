---
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { readingTime } from '../../utils/readingTime';
import { isPublished } from '../../utils/content';

type NoteEntry = CollectionEntry<'lab'> | CollectionEntry<'creative'> | CollectionEntry<'comms'>;

export async function getStaticPaths() {
  const lab = await getCollection('lab', isPublished);
  const creative = await getCollection('creative', isPublished);
  const comms = await getCollection('comms', isPublished);

  const entries: Array<{ item: NoteEntry; collection: 'lab' | 'creative' | 'comms' }> = [
    ...lab.map((item) => ({ item, collection: 'lab' as const })),
    ...creative.map((item) => ({ item, collection: 'creative' as const })),
    ...comms.map((item) => ({ item, collection: 'comms' as const })),
  ];

  return entries.map(({ item, collection }) => ({
    params: { slug: item.slug },
    props: { item, collection },
  }));
}

const { item, collection } = Astro.props as { item: NoteEntry; collection: 'lab' | 'creative' | 'comms' };
const { Content } = await item.render();
const reading = readingTime(item.body);
const badgeLabel = collection === 'lab' ? 'Experiment' : 'Working Note';
const laneLabel = collection === 'lab' ? 'Lab' : item.data.lane ?? 'Note';
---
<ArticleLayout title={item.data.title} description={item.data.description}>
  <header>
    <div class="meta-row">
      <span class="badge">{badgeLabel}</span>
      <span class="divider"></span>
      <span>{laneLabel}</span>
      <span class="divider"></span>
      <span>{item.data.date.toLocaleDateString()}</span>
      <span class="divider"></span>
      <span>{reading.label}</span>
    </div>
    <h1>{item.data.title}</h1>
    <p class="muted">{item.data.description}</p>
    <div style="margin-top:0.6rem;">
      {item.data.tags.map((tag) => (
        <span class="tag">{tag}</span>
      ))}
    </div>
  </header>

  {collection === 'lab' ? (
    <section>
      <h2>Hypothesis</h2>
      <p>{item.data.hypothesis}</p>
      <h3>Build notes</h3>
      <p>{item.data.build_notes}</p>
      <Content />
      <h3>Next iteration</h3>
      <p>{item.data.next_iteration}</p>
    </section>
  ) : (
    <Content />
  )}
</ArticleLayout>
